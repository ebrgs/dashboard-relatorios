<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Seguro de Obras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tela { display: none; } /* Esconde todas as telas por padr√£o */
        .tela-ativa { display: block; animation: fadeIn 0.5s; } /* Mostra a ativa */
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card-resumo { transition: transform 0.2s; }
        .card-resumo:hover { transform: translateY(-5px); }

        button:disabled {
            background-color: #cccccc !important; /* Fica cinza */
            color: #666666 !important;
            cursor: not-allowed; /* O mouse vira um sinal de proibido */
            opacity: 0.7;
        }

        .statusRelatorio {
            position: absolute;
            right: 50px;
            top: 40%;
            border: solid 1px black;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            overflow: hidden;
        }
        .statusAprovado {
            background-color: green;
        }
        .statusRevisao {
            background-color: red;
        }
        .statusPreenchendo {
            background-color: yellow;
        }

        #tabelaCorpo > tr {
            position: relative;
            align-items: center;
        }
    </style>
</head>
<body class="bg-light">

    <div id="telaLogin" class="tela container py-5" style="height: 100vh;">
        <div class="row justify-content-center align-items-center h-100">
            <div class="col-md-4">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <h3>üîê Acesso Restrito</h3>
                            <p class="text-muted">Fa√ßa login para acessar os relat√≥rios</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Usu√°rio</label>
                            <input type="text" id="loginUser" class="form-control form-control-lg" placeholder="ex: admin">
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">Senha</label>
                            <input type="password" id="loginPass" class="form-control form-control-lg" placeholder="******">
                        </div>
                        
                        <button type="submit" id="botaoLogin" onclick="fazerLogin(event)" class="btn btn-primary w-100 btn-lg">Entrar no Sistema</button>
                        
                        <div id="msgErro" class="alert alert-danger mt-3 text-center" style="display:none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="telaDashboard" class="tela container py-5">
        
        <div class="d-flex justify-content-between align-items-center mb-5 border-bottom pb-3">
            <div>
                <h1 class="h3 mb-0">üìä Gest√£o de M√£o de Obra</h1>
                <small class="text-muted">Logado como: <strong id="usuarioLogado">...</strong></small>
            </div>
            <button onclick="fazerLogout()" class="btn btn-outline-danger">Sair / Logout</button>
        </div>

        <div class="card p-4 shadow-sm mb-4 border-0">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Selecione a Data</label>
                    <input type="date" id="dataInput" class="form-control form-control-lg">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Setor / Grupo</label>
                    <select id="setorInput" class="form-select form-select-lg">
                        <option value="">Todos os Setores</option>
                        <option value="CT-251 Carajas">CT-251 Caraj√°s</option>
                        <option value="Fabrica Omega">Fabrica Omega</option>
                    </select>
                </div>

                <div class="col-md-3 d-flex gap-2">
                    <button onclick="buscarDados(false)" id="botaoBuscar" class="btn btn-primary flex-grow-1 btn-lg">üîç Buscar</button>
                    <button onclick="buscarDados(true)" class="btn btn-outline-secondary" title="For√ßar Atualiza√ß√£o">üîÑ</button>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center my-5" style="display:none">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-2 fs-5 text-muted">Processando relat√≥rios e consolidando dados...</p>
        </div>

        <div id="resultArea" style="display:none">
            
            <div class="row mb-4 text-center g-3">
                <div class="col-md-4">
                    <div class="card card-resumo bg-primary text-white p-3 border-0 shadow-sm">
                        <h2 class="display-6 fw-bold"><span id="totalColaboradores">0</span></h2>
                        <small class="text-white-50 text-uppercase fw-bold">Colaboradores</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-resumo bg-success text-white p-3 border-0 shadow-sm">
                        <h2 class="display-6 fw-bold"><span id="totalObras">0</span></h2>
                        <small class="text-white-50 text-uppercase fw-bold">Obras Ativas</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-resumo bg-secondary text-white p-3 border-0 shadow-sm">
                        <h2 class="display-6 fw-bold"><span id="totalRelatorios">0</span></h2>
                        <small class="text-white-50 text-uppercase fw-bold">Relat√≥rios Baixados</small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mb-3">
                <button onclick="exportarExcel()" class="btn btn-success me-2">
                    üì• Baixar Planilha (.csv)
                </button>
                <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#modalConferencia">
                    üïµÔ∏è Conferir Faltas
                </button>
                <button class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#modalEquipamentos">
                    üöú Conferir Frota
                </button>
            </div>
            
            <div class="d-flex justify-content-center mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="filtrarTabela('todos', this)" id="btnTodos">
                        üìã Todos
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filtrarTabela('Pessoa', this)">
                        üë∑ M√£o de Obra (RDO)
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filtrarTabela('Equipamento', this)">
                        üöú Equipamentos (Parte Di√°ria)
                    </button>
                </div>
            </div>
            
            <div class="card shadow-sm border-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Funcion√°rio</th>
                                <th scope="col">Matricula/TAG</th>
                                <th scope="col">Fun√ß√£o</th>
                                <th scope="col">Obra (Origem)</th>
                                <th scope="col" class="text-end">ID Relat√≥rio</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCorpo">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConferencia" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark">üïµÔ∏è Gest√£o de Efetivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            
                            <div class="btn-group w-100 mb-3">
                                <button onclick="alternarModo('conferencia')" class="btn btn-outline-dark active" id="btnModoConf">Confer√™ncia</button>
                                <button onclick="alternarModo('edicao')" class="btn btn-outline-dark" id="btnModoEdit">‚úèÔ∏è Editar/Excluir</button>
                            </div>

                            <div id="areaConferencia">
                                <button onclick="carregarEfetivoDoBanco()" class="btn btn-primary w-100 mb-2">
                                    üì• Usar Cadastro do Sistema
                                </button>
                                <p class="text-center text-muted my-1">- OU -</p>
                                <textarea id="listaNomesInput" class="form-control" rows="5" placeholder="Cole nomes aqui..."></textarea>
                                <button onclick="cadastrarNovos()" class="btn btn-outline-success w-100 mt-2 btn-sm">
                                    üíæ Adicionar estes nomes ao Banco
                                </button>
                            </div>

                            <div id="areaEdicao" style="display:none; max-height: 400px; overflow-y: auto;">
                                <p class="small text-muted">Clique na lixeira para remover definitivamente.</p>
                                <ul id="listaGerenciamento" class="list-group">
                                    </ul>
                            </div>

                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="fw-bold text-danger">‚ö†Ô∏è Faltantes Hoje:</label>
                                <button onclick="verificarFaltas()" class="btn btn-success btn-sm">üîÑ Verificar</button>
                            </div>
                            <div class="btn-group w-100 mb-2" role="group">
                                <button onclick="copiarFaltantes()" class="btn btn-outline-secondary btn-sm" title="Copiar para √Årea de Transfer√™ncia">
                                    üìã Copiar Lista
                                </button>
                                <button onclick="baixarFaltantesExcel()" class="btn btn-outline-success btn-sm" title="Baixar Arquivo Excel">
                                    üì• Baixar Excel
                                </button>
                            </div>
                            <ul id="listaFaltantes" class="list-group list-group-flush border rounded bg-light" style="height: 300px; overflow-y: auto;">
                                <li class="list-group-item text-muted text-center p-4">Carregue a lista ou cole nomes ao lado para verificar.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalEquipamentos" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">üöú Gest√£o de Frota</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <div class="btn-group w-100 mb-3">
                                <button onclick="alternarModoEquip('conferencia')" class="btn btn-outline-dark active" id="btnModoConfEquip">Confer√™ncia</button>
                                <button onclick="alternarModoEquip('edicao')" class="btn btn-outline-dark" id="btnModoEditEquip">‚úèÔ∏è Editar Frota</button>
                            </div>

                            <div id="areaConferenciaEquip">
                                <button onclick="carregarFrotaDoBanco()" class="btn btn-primary w-100 mb-2">üì• Usar Cadastro da Frota</button>
                                <textarea id="listaEquipInput" class="form-control" rows="5" placeholder="Cole a lista de equipamentos..."></textarea>
                                <button onclick="cadastrarEquipNovos()" class="btn btn-outline-success w-100 mt-2 btn-sm">üíæ Salvar na Frota</button>
                            </div>

                            <div id="areaEdicaoEquip" style="display:none; max-height: 400px; overflow-y: auto;">
                                <ul id="listaGerenciamentoEquip" class="list-group"></ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="fw-bold text-danger">‚ö†Ô∏è Equipamentos Parados/Faltantes:</label>
                                <button onclick="verificarFaltasEquip()" class="btn btn-success btn-sm">üîÑ Verificar</button>
                            </div>

                            <div class="btn-group w-100 mb-2">
                                <button onclick="copiarEquipFaltantes()" class="btn btn-outline-secondary btn-sm">üìã Copiar</button>
                                <button onclick="baixarEquipExcel()" class="btn btn-outline-success btn-sm">üì• Excel</button>
                            </div>

                            <ul id="listaFaltantesEquip" class="list-group list-group-flush border rounded bg-light" style="height: 300px; overflow-y: auto;">
                                <li class="list-group-item text-muted text-center p-4">Aguardando verifica√ß√£o...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- MODO DESENVOLVIMENTO (LOCAL) ---
        // const API_URL = 'http://localhost:3000';

        // --- MODO PRODU√á√ÉO (NUVEM) ---
        const API_URL = 'https://api-obras.onrender.com';
        let dadosGlobais = []; // Guarda dados para exportar CSV

        // 1. Verifica login ao abrir
        window.onload = () => {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('username');
            
            if (token) {
                document.getElementById('usuarioLogado').innerText = user || 'Usu√°rio';
                mostrarTela('telaDashboard');
            } else {
                mostrarTela('telaLogin');
            }
        };

        function mostrarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('tela-ativa'));
            document.getElementById(id).classList.add('tela-ativa');
        }

        // 2. Fun√ß√£o de Login
        async function fazerLogin(event) {
            event.preventDefault();

            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            const msgErro = document.getElementById('msgErro');
            const btnLogin = document.getElementById('botaoLogin');

            // Limpa erros anteriores
            msgErro.innerText = '';
            btnLogin.innerText = '‚è≥ Acordando servidor...'
            btnLogin.disabled = true;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });

                const data = await res.json();

                if (res.ok) {
                    btnLogin.innerText = '‚úÖ Sucesso!'
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    document.getElementById('usuarioLogado').innerText = data.username;
                    mostrarTela('telaDashboard');
                } else {
                    msgErro.innerText = data.erro || 'Erro ao logar';
                    msgErro.style.display = 'block';
                }
            } catch (e) {
                console.error(e);
                msgErro.innerText = 'Erro de conex√£o com o servidor';
                msgErro.style.display = 'block';
            } finally {
                const token = localStorage.getItem('token');
                if (!token) {
                    btnLogin.disabled = false;
                    btnLogin.innerText = 'Entrar no Sistema'
                }
            }
        }

        function fazerLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            mostrarTela('telaLogin');
            // Limpa dados da tela
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('dataInput').value = '';
        }

        let filtroAtual = 'todos'
        // 3. Fun√ß√£o de Buscar Dados (AQUI EST√Å A M√ÅGICA DA TABELA)
        async function buscarDados(forcarAtualizacao = false) {
            const data = document.getElementById('dataInput').value;
            const setor = document.getElementById('setorInput').value;
            const token = localStorage.getItem('token');
            const btnBuscar = document.getElementById('botaoBuscar');
            
            btnBuscar.disabled = true

            if (!data) {
                btnBuscar.disabled = false;
                return alert('Selecione uma data!');
            } 

            // UI Changes
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('tabelaCorpo').innerHTML = ''; // Limpa tabela antiga

            try {
                const response = await fetch(`${API_URL}/api/colaboradores?data=${data}&forcar=${forcarAtualizacao}&setor=${setor}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}` // Manda o crach√°
                    }
                });

                // Se o token venceu
                if (response.status === 401 || response.status === 403) {
                    alert('Sess√£o expirada. Por favor, fa√ßa login novamente.');
                    fazerLogout();
                    return;
                }

                const json = await response.json();

                if (json.erro) throw new Error(json.erro);

                // --- PREENCHENDO A TELA ---
                dadosGlobais = json.listaColaboradores; // Salva para o Excel

                // 1. Cards
                document.getElementById('totalColaboradores').innerText = json.resumo.colaboradores;
                document.getElementById('totalObras').innerText = json.resumo.obras;
                document.getElementById('totalRelatorios').innerText = json.resumo.relatorios;

                filtrarTabela('todos', document.getElementById('btnTodos'))

                document.getElementById('resultArea').style.display = 'block'

            } catch (error) {
                console.error(error);
                alert('Ocorreu um erro: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                btnBuscar.disabled = false
            }
        }

        function filtrarTabela(tipo, botaoClicado) {
            filtroAtual = tipo;

            document.querySelectorAll('.btn-group .btn').forEach(b => {
                b.classList.remove('active', 'btn-primary');
                b.classList.add('btn-outline-primary');
            });

            botaoClicado.classList.remove('btn-outline-primary');
            botaoClicado.classList.add('active', 'btn-primary');

            let dadosFiltrados;

            if(tipo === 'todos') {
                dadosFiltrados = dadosGlobais;
            } else {
                dadosFiltrados =dadosGlobais.filter(item => item.tipo === tipo);
            }

            renderizarTabela(dadosFiltrados);
        }

        function renderizarTabela(lista) {
            const tbody = document.getElementById('tabelaCorpo');

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Nenhum registro encontrado neste filtro.</td></tr>';
                return
            }

            const coreStatus =  {
                "Aprovado" : "bg-success",
                "Revisar Relat√≥rio" : "bg-danger",
                "Preenchendo Relat√≥rio" : "bg-warning"
            }

            const linhasHTML = lista.map(item => {
                const icone = item.tipo === 'Equipamento' ? 'üöú' : 'üë§';
                console.log(item.statusRelatorio)

                return `
                    <tr>
                        <td class="fw-bold">${icone} ${item.funcionario}</td>
                        <td class="fw-bold">${item.matricula}</td>
                        <td><span class="badge bg-light text-dark border">${item.funcao || 'N√£o inf.'}</span></td>
                        <td>${item.origemObra}</td>
                        <td class="text-end text-muted"><small>#${item.idRelatorio}</small></td>
                        <td class="statusRelatorio ${coreStatus[item.statusRelatorio]}">${item.statusRelatorio}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = linhasHTML;
        }

        // --- NOVAS FUN√á√ïES DE EFETIVO ---

        // 1. Cadastrar nomes no banco (Voc√™ faz isso uma vez)
        async function cadastrarNovos() {
            const texto = document.getElementById('listaNomesInput').value;
            if (!texto.trim()) return alert("Digite nomes para salvar.");
            
            const lista = texto.split('\n').filter(n => n.trim().length > 0);
            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_URL}/api/funcionarios/importar`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ listaNomes: lista })
                });
                
                if (res.ok) {
                    alert("‚úÖ Nomes salvos no banco!");
                    document.getElementById('listaNomesInput').value = ''; // Limpa
                } else {
                    alert("Erro ao salvar.");
                }
            } catch (e) { console.error(e); }
        }

        // 2. Carregar do Banco e j√° verificar
        async function carregarEfetivoDoBanco() {
            const token = localStorage.getItem('token');
            const btn = event.target; // O bot√£o que foi clicado
            
            btn.innerText = "‚è≥ Buscando...";
            
            try {
                const res = await fetch(`${API_URL}/api/funcionarios`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const listaDoBanco = await res.json();
                
                // Joga a lista do banco para dentro do input (escondido ou vis√≠vel) 
                // para a fun√ß√£o 'verificarFaltas' usar
                document.getElementById('listaNomesInput').value = listaDoBanco.join('\n');
                
                // J√° roda a verifica√ß√£o automaticamente
                verificarFaltas();
                
                btn.innerText = "‚úÖ Lista Carregada!";
                setTimeout(() => btn.innerText = "üì• Usar Cadastro do Sistema", 2000);
                
            } catch (e) {
                alert("Erro ao buscar cadastro.");
                btn.innerText = "Erro ‚ùå";
            }
        }

        // --- L√≥gica de Confer√™ncia de Faltas ---

// 1. Fun√ß√£o Auxiliar: Limpa o texto para compara√ß√£o justa
function normalizarTexto(texto) {
    if (!texto) return "";
    return texto
        .toLowerCase()                  // Tudo min√∫sculo
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos (√£ -> a)
        .trim();                        // Remove espa√ßos do come√ßo e fim
}

// Vari√°vel global para guardar a √∫ltima lista de faltas gerada
let listaFaltantesGlobal = [];

        function verificarFaltas() {
            // 1. Pega a lista que o usu√°rio colou
            const inputTexto = document.getElementById('listaNomesInput').value;
            if (!inputTexto.trim()) return alert("Cole uma lista de nomes primeiro!");

            // Transforma o texto do textarea em um Array (linha por linha)
            const listaEsperada = inputTexto.split('\n').filter(nome => nome.trim().length > 0);

            // 2. Pega a lista de quem VEIO (que j√° buscamos da API)
            // Filtramos apenas quem √© 'Pessoa' para n√£o comparar trator com gente
            const listaPresentes = dadosGlobais
                .filter(item => item.tipo === 'Pessoa')
                .map(item => normalizarTexto(item.funcionario));

            // 3. A M√°gica: Filtra quem N√ÉO est√° na lista de presentes
            const faltantes = listaEsperada.filter(nomeOriginal => {
                const nomeLimpo = normalizarTexto(nomeOriginal);
                // Se a lista de presentes N√ÉO incluir este nome, ele faltou
                return !listaPresentes.includes(nomeLimpo);
            });

            // --- SALVA NA VARI√ÅVEL GLOBAL PARA EXPORTAR DEPOIS ---
            listaFaltantesGlobal = faltantes; 
            // ------------------------------------

            // 4. Exibe o resultado
            const ul = document.getElementById('listaFaltantes');
            ul.innerHTML = '';

            if (faltantes.length === 0) {
                ul.innerHTML = '<li class="list-group-item list-group-item-success">‚úÖ Todos est√£o presentes!</li>';
            } else {
                faltantes.forEach(nome => {
                    ul.innerHTML += `<li class="list-group-item list-group-item-danger">‚ùå ${nome}</li>`;
                });
            }
        }

        // 2. Fun√ß√£o para Copiar (Ideal para WhatsApp)
function copiarFaltantes() {
    if (listaFaltantesGlobal.length === 0) return alert("N√£o h√° faltantes para copiar.");

    const texto = "‚ö†Ô∏è *RELAT√ìRIO DE FALTAS* ‚ö†Ô∏è\nData: " + document.getElementById('dataInput').value + "\n\n" + 
                  listaFaltantesGlobal.map(nome => "- " + nome).join('\n');

    navigator.clipboard.writeText(texto).then(() => {
        alert("‚úÖ Lista copiada! Pode colar no WhatsApp.");
    });
}

// 3. Fun√ß√£o para Baixar Excel (.csv)
function baixarFaltantesExcel() {
    if (listaFaltantesGlobal.length === 0) return alert("N√£o h√° faltantes para baixar.");

    // Cabe√ßalho + Dados
    let csvConteudo = "NOME DO COLABORADOR;STATUS\n";
    listaFaltantesGlobal.forEach(nome => {
        csvConteudo += `${nome};FALTOU\n`;
    });

    // Cria o arquivo para download
    const blob = new Blob(["\ufeff" + csvConteudo], { type: 'text/csv;charset=utf-8;' }); // \ufeff ajuda o Excel a ler acentos
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    
    const dataHoje = document.getElementById('dataInput').value;
    link.setAttribute("href", url);
    link.setAttribute("download", `Faltas_${dataHoje}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

        // --- NOVAS FUN√á√ïES DE GERENCIAMENTO ---

// 1. Alterna entre "Verificar Faltas" e "Apagar Nomes"
async function alternarModo(modo) {
    const areaConf = document.getElementById('areaConferencia');
    const areaEdit = document.getElementById('areaEdicao');
    
    if (modo === 'conferencia') {
        areaConf.style.display = 'block';
        areaEdit.style.display = 'none';
        document.getElementById('btnModoConf').classList.add('active');
        document.getElementById('btnModoEdit').classList.remove('active');
    } else {
        areaConf.style.display = 'none';
        areaEdit.style.display = 'block';
        document.getElementById('btnModoConf').classList.remove('active');
        document.getElementById('btnModoEdit').classList.add('active');
        
        // Quando entra no modo edi√ß√£o, j√° carrega a lista para mostrar as lixeiras
        await renderizarListaEdicao();
    }
}

// 2. Busca nomes e desenha a lista com lixeiras
async function renderizarListaEdicao() {
    const ul = document.getElementById('listaGerenciamento');
    ul.innerHTML = '<div class="text-center mt-3"><div class="spinner-border text-primary"></div></div>';
    
    const token = localStorage.getItem('token');
    
    try {
        const res = await fetch(`${API_URL}/api/funcionarios`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const lista = await res.json();
        
        ul.innerHTML = ''; // Limpa loading
        
        if(lista.length === 0) {
            ul.innerHTML = '<li class="list-group-item text-center">Nenhum cadastro encontrado.</li>';
            return;
        }

        lista.forEach(nome => {
            ul.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${nome}
                    <button onclick="excluirFuncionario('${nome}')" class="btn btn-sm btn-outline-danger" title="Excluir">
                        üóëÔ∏è
                    </button>
                </li>
            `;
        });
        
    } catch (e) {
        ul.innerHTML = '<p class="text-danger">Erro ao carregar lista.</p>';
    }
}

// 3. Fun√ß√£o que APAGA de verdade
async function excluirFuncionario(nome) {
    if (!confirm(`Tem certeza que deseja remover "${nome}" do sistema?`)) return;

    const token = localStorage.getItem('token');

    try {
        const res = await fetch(`${API_URL}/api/funcionarios`, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ nome: nome })
        });

        if (res.ok) {
            // Recarrega a lista para sumir com o nome exclu√≠do
            renderizarListaEdicao();
        } else {
            alert("Erro ao excluir. Tente novamente.");
        }
    } catch (e) {
        console.error(e);
        alert("Erro de conex√£o.");
    }
}
// --- L√ìGICA DE EQUIPAMENTOS ---

let listaEquipGlobal = [];

// 1. Alternar Abas
async function alternarModoEquip(modo) {
    const areaConf = document.getElementById('areaConferenciaEquip');
    const areaEdit = document.getElementById('areaEdicaoEquip');
    
    if (modo === 'conferencia') {
        areaConf.style.display = 'block';
        areaEdit.style.display = 'none';
        document.getElementById('btnModoConfEquip').classList.add('active');
        document.getElementById('btnModoEditEquip').classList.remove('active');
    } else {
        areaConf.style.display = 'none';
        areaEdit.style.display = 'block';
        document.getElementById('btnModoConfEquip').classList.remove('active');
        document.getElementById('btnModoEditEquip').classList.add('active');
        await renderizarEdicaoEquip();
    }
}

// 2. Carregar e Verificar (A M√°gica acontece aqui)
async function carregarFrotaDoBanco() {
    const token = localStorage.getItem('token');
    const btn = event.target;
    btn.innerText = "‚è≥ Buscando...";
    
    try {
        const res = await fetch(`${API_URL}/api/equipamentos`, { headers: { 'Authorization': `Bearer ${token}` } });
        const lista = await res.json();
        document.getElementById('listaEquipInput').value = lista.join('\n');
        verificarFaltasEquip(); // J√° verifica autom√°tico
        btn.innerText = "‚úÖ Frota Carregada!";
        setTimeout(() => btn.innerText = "üì• Usar Cadastro da Frota", 2000);
    } catch (e) { alert("Erro ao buscar frota."); }
}

function verificarFaltasEquip() {
    const inputTexto = document.getElementById('listaEquipInput').value;
    if (!inputTexto.trim()) return alert("Lista vazia!");

    const listaEsperada = inputTexto.split('\n').filter(n => n.trim().length > 0);

    // --- AQUI MUDA: Filtramos apenas 'Equipamento' ---
    const listaPresentes = dadosGlobais
        .filter(item => item.tipo === 'Equipamento') 
        .map(item => normalizarTexto(item.funcionario)); // Lembre que salvamos o nome da m√°quina no campo 'funcionario'

    const faltantes = listaEsperada.filter(nomeOriginal => {
        return !listaPresentes.includes(normalizarTexto(nomeOriginal));
    });

    listaEquipGlobal = faltantes; // Salva para exportar

    const ul = document.getElementById('listaFaltantesEquip');
    ul.innerHTML = '';
    
    if (faltantes.length === 0) {
        ul.innerHTML = '<li class="list-group-item list-group-item-success">‚úÖ Toda a frota operou hoje!</li>';
    } else {
        faltantes.forEach(nome => {
            ul.innerHTML += `<li class="list-group-item list-group-item-danger">üöú ${nome}</li>`;
        });
    }
}

// 3. Cadastrar Novos
async function cadastrarEquipNovos() {
    const texto = document.getElementById('listaEquipInput').value;
    const lista = texto.split('\n').filter(n => n.trim().length > 0);
    const token = localStorage.getItem('token');

    await fetch(`${API_URL}/api/equipamentos/importar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ listaNomes: lista })
    });
    alert("‚úÖ Frota atualizada!");
}

// 4. Gerenciar (Excluir)
async function renderizarEdicaoEquip() {
    const ul = document.getElementById('listaGerenciamentoEquip');
    ul.innerHTML = 'Carregando...';
    const token = localStorage.getItem('token');
    
    const res = await fetch(`${API_URL}/api/equipamentos`, { headers: { 'Authorization': `Bearer ${token}` } });
    const lista = await res.json();
    
    ul.innerHTML = '';
    lista.forEach(nome => {
        ul.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${nome}
                <button onclick="excluirEquip('${nome}')" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
            </li>`;
    });
}

async function excluirEquip(nome) {
    if (!confirm(`Remover "${nome}" da frota?`)) return;
    const token = localStorage.getItem('token');
    await fetch(`${API_URL}/api/equipamentos`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ nome: nome })
    });
    renderizarEdicaoEquip();
}

// 5. Exportar
function copiarEquipFaltantes() {
    if (listaEquipGlobal.length === 0) return alert("Nada para copiar.");
    const texto = "‚ö†Ô∏è *FROTA PARADA HOJE* ‚ö†Ô∏è\nData: " + document.getElementById('dataInput').value + "\n\n" + 
                  listaEquipGlobal.map(nome => "- " + nome).join('\n');
    navigator.clipboard.writeText(texto).then(() => alert("Copiado!"));
}

function baixarEquipExcel() {
    if (listaEquipGlobal.length === 0) return alert("Nada para baixar.");
    let csv = "EQUIPAMENTO;STATUS\n";
    listaEquipGlobal.forEach(n => csv += `${n};PARADO\n`);
    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Frota_Parada_${document.getElementById('dataInput').value}.csv`;
    link.click();
}

        // 4. Exportar Excel
        function exportarExcel() {
            if (dadosGlobais.length === 0) return alert("Sem dados para exportar");

            let csv = "Funcionario;matricula/tag;Funcao;Obra;Data;ID_Relatorio\n";

            dadosGlobais.forEach(row => {
                // Tratamento simples para evitar quebra de CSV se tiver ponto e v√≠rgula no nome
                const func = row.funcionario ? row.funcionario.replace(/;/g, ' ') : '';
                const obra = row.origemObra ? row.origemObra.replace(/;/g, ' ') : '';
                
                csv += `${func};${row.matricula};${row.funcao};${obra};${row.data};${row.idRelatorio}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `MaoDeObra_${dadosGlobais[0].data}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>